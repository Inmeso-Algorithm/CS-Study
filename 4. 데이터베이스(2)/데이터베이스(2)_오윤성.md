# 4. 데이터베이스

## 목차

2. ERD와 정규화 과정
3. 트랜잭션과 무결성

ERD(Entity Relationship Diagram)는 데이터베이스를 구축할 때 가장 기초적인 뼈대 역할을 하며, 릴레이션 간의 관계들을 정의한 것입니다.

### ERD의 중요성
시스템의 요구 사항을 기반으로 작성되며 이 ERD를 기반으로 데이터베이스를 구축합니다. 이후에도 디버깅 또는 비즈니스 프로세스 재설계가 필요한 경우에도 설계도 역할을 담당하기도 합니다. 
하지만 ERD는 관계형 구조로 표현할 수 있는데 데이터를 구성하는 데 유용할 수 있지만 비정형 **데이터를 충분히 표현할 수 없다**는 단점이 있습니다.

※ 비정형 데이터 : 비구조화 데이터를 말하며, 미리 정의된 데이터 모델이 없거나 미리 정의된 방식으로 정리되지 않은 정보로 말한다. 

### 정규화 과정
#### 정규형 원칙
> 같은 의미를 표현하는 릴레이션이지만 좀 더 좋은 구조로 만들어야 하고, 자료의 중복성은 감소해야 하고, 독립적인 관계는 별개의 릴레이션으로 표현해야 하며, 각각의 릴레이션은 독립적인 표현이 가능해야 하는 것을 말합니다. 

#### 제1정규형
릴레이션의 모든 도메인이 더 이상 분해될 수 없는 원자 값만으로 구성되어야 합니다. 릴레이션의 속성 값 중에서 한 개의 기본키에 대해 두 개 이상의 값을 가지는 반복 집합이 있어서는 안 됩니다. 

|ID|이름|과목|성취도|
|--|--|--|--|
|1|오윤성|일반 수학1|{90%, 10%}|
|2|정규호|공업 수학1|{10%, 5%}|

성취도에서 반복집합이 있으므로 제 1정규형 조건에 위배됩니다.
아래의 표처럼 반복 집합을 제거하면 제 1정규형을 만족합니다.

|ID|이름|과목|성취도|
|--|--|--|--|
|1|오윤성|일반 수학1|90%|
|1|오윤성|일반 수학1|10%|
|2|정규호|공업 수학1|10%|
|2|정규호|공업 수학1|5%|

대부분 정규형에는 이상현상이 존재한다.

제 1정규형에는 아래와 같은 이상 현상이 존재한다. 
- 삽입 이상 : 불필요한 정보가 필요함
- 삭제 이상 : 불필요한 정보까지 삭제됨
- 갱신 이상 : 불필요한 정보까지 갱신 필요

이러한 이상현상이 발생하는 이유는, 기본키가 아닌 속성들이 기본키에 완전 함수 종속되지 못하고 부분 함수 종속되어 있기 때문입니다. 즉, 기본키의 일부 속성에만 의존하고 있다는 의미입니다.



#### 제2정규형
>릴레이션이 제1정규형이며 부분 함수의 종속성을 제거한 형태를 말합니다. 부분 함수의 종속성 제거란 기본키가 아닌 모든 속성이 기본키에 완전 함수 종속적인 것을 말합니다. 

즉, 제1 정규형이면서, 기본키(primary key)에 속하지 않은 속성 모두가 기본키에 완전 함수 종속인 정규형

|ID|이름|과목|성취도|
|--|--|--|--|
|1|오윤성|일반 수학1|90%|
|1|오윤성|일반 수학1|10%|
|2|정규호|공업 수학1|10%|
|2|정규호|공업 수학1|5%|
---
|ID|이름|
|--|--|
|1|오윤성|
|2|정규호|
---

|이름|과목|성취도|
|--|--|--|
|오윤성|일반 수학1|90%|
|오윤성|일반 수학1|10%|
|정규호|공업 수학1|10%|
|정규호|공업 수학1|5%|

기본키인 {이름, 수강명}과 같은 완전 종속된 유저번호 릴레이션과 {이름, 수강명}에 따른 성취도 릴레이션으로 분리하였습니다.

제 2정규형에도 이상현상이 존재합니다.
- 삽입 이상 : 불필요한 정보가 필요함
- 삭제 이상 : 불필요한 정보까지 삭제됨
- 갱신 이상 : 불필요한 정보까지 갱신 필요

여전히 이상현상이 발생하는 이유는 '이행적 함수 종속성' 때문입니다.

이행적 함수 종속성은 속성이 A->B이고, B->C이면서 A->C의 관계가 있는 것을 말합니다. 

### 제 3정규형
> 제 2정규형이면서, 이행적 함수 종속성을 제거한 정규형

즉, 기본키에 속하지 않은 모든 속성이 기본키에 이행적 함수 종속이 아닐 때 제 3정규형이라합니다. 다르게 표현하면, 기본키 이외의 속성이 그 외 다른 속성을 결정할 수 없다는 것입니다.

![](https://velog.velcdn.com/images/oyunseong/post/81e79b5f-caa4-4501-a2ae-40a6e94d4e64/image.png)

사진 출처 : https://rebro.kr/160

위 사진은 이행적 함수 종속 관계에 있는 속성을 분리하여 테이블을 나타낸 것입니다. 

![](https://velog.velcdn.com/images/oyunseong/post/35ae92d1-404c-43b6-80c6-d5d003f29d5e/image.png)

제 3정규형은 1,2정규형에서 발생했던 이상현상이 해결됩니다.

### BCNF, 보이스/코드 정규형
> 제 3정규형이고, 결정자가 후보키가 아닌 함수 종속 관계를 제거하여 릴레이션의 함수 종속 관계에서 모든 결정자가 후보키인 상태를 말합니다. 

즉, 제 3정규형을 강화시킨 개념입니다. 

#### Determinant, 결정자
결정자는 주어진 릴레이션에서 다른 속성를 고유하게 결정하는 하나 이상의 속성입니다.

![](https://velog.velcdn.com/images/oyunseong/post/7ef3c2d3-6be9-4e6c-9e51-989c51a7c5a3/image.png)

여기서 사원번호와 부서번호가 결정자입니다.
사진 출처 : https://m.blog.naver.com/kookh1/120188411660

> 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위를 말하며 데이터베이스에 접근하는 방법은 쿼리이므로, 즉 여러 개의 쿼리들을 하나로 묶는 단위를 말합니다. 

이에 대한 특징으로 (ACID) 원자성, 일관성, 독립성, 지속성이 있습니다.

### 😁 Atomicity, 원자성
>트랜잭션과 관련된 일을 모두 수행되었거나 되지 않았거나를 보장하는 특징

예를 들어 트랜잭션을 커밋했는데, 문제가 발생하여 롤백하는 경우 그 이후에 모두 수행되지 않았음을 보장하는 것을 뜻합니다. 

#### commit and rollback, 커밋과 롤백
`commit` : 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어
트랜잭션 단위로 수행되며 변경된 내용이 모두 영구적으로 저장되는 것을 말합니다. 
즉, "하나의 트랜잭션이 성공적으로 수행되었다"라고 합니다.

`rollback` : 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 명령어

commit과 rollback 덕분에 데이터의 무결성이 보장됩니다. 

#### 트랜잭션 전파
>여러 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것을 말합니다.

### 🍔 Consistency, 일관성
> '허용된 방식'으로만 데이터를 변경해야 하는 것을 의미합니다. 

### 🍟 Isolation, 격리성
> 트랜잭션 수행 시 서로 끼어들지 못하는 것을 말합니다. 

격리성은 여러 개의 격리 수준으로 나뉘어 격리성을 보장합니다. 

### 격리 수준에 따라 발생하는 현상

#### 🍖 Phantom read, 팬텀 리드
한 트랜잭션 내에서 **동일한 쿼리**를 보냈을 때 해당 조회 결과가 다른 경우를 말합니다 

#### 🍗 non-repeatable read, 반복 가능하지 않은 조회
한 트랜잭션 내의 같은 행에 두 번 이상 조회가 발생했는데, 그 값이 다른 경우
예를 들어 
1. 현재 닭다리 개수가 100개일 때, 
2. 사용자 A가 닭다리의 개수를 조회했는데, 
3. 그 이후 사용자 B가 그 값을 1로 변경해서 커밋하면 
4. 사용자 A는 100이 아닌 1을 읽게됩니다.

#### 🥞 Dirty read, 더티 리드 
한 트랜잭션이 실행 중일 때 다른 트랜잭션에 의해 수정되었지만 아직 `커밋되지 않은` 행의 데이터를 읽을 수 있을 때 발생합니다. 

예를 들어
1. 사용자 A가 닭다리의 개수를 100에서 1로 수정했는데 아직 커밋을 하지 않았을 때,
2. 사용자 B는 닭다리의 개수를 1이라고 조회함

#### 격리 수준
|수준|내용|단점|
|:--:|--|--|
|SERIALIZABLE|순차적으로 진행시키는 것|교착 상태가 일어날 확률이 높음|
|REPEATABLE_READ|행 수정은 불가능하지만 행 추가는 가능|이후에 추가된 행이 발견될 수 있음|
|🍎READ_COMMITTED|커밋하지 않은 정보는 읽을 수 없음|동시에 접근 가능하여 다른 내용이 발견될 수 있음|
|READ_UNCOMMITTED|커밋되기 이전에 다른 트랜잭션에 노출됨|무결성이 유지되지 않을 수 있음|

### 🥩 Durability, 지속성
>성공적으로 수행된 트랜잭션은 영원히 반영되어야 하는 것을 의미합니다. 

이는 데이터베이스에 장애가 발생해도 원상복구가 되어야 함을 뜻하며, 이를 위해 체크섬, 저널링, 롤백 등의 기능을 제공합니다. 

※ Checksum, 체크섬 : 중복 검사의 한 형태로, 오류 정정을 통해 송신된 자료의 무결성을 보호하느 단순한 방법
※ Journaling, 저널링 : 시스템에 변경 사항을 `commit`하기 전에 트랜잭션 등 변경사항에 대한 로그를 남기는 것

### 🍠 무결성
> 데이터의 정확성, 일관성, 유효성을 유지하는 것을 말합니다.

무결성이 보장되어야 데이터베이스에 저장된 값과 그 값에 해당하는 현실 세계의 실제 값이 일치하는지에 대한 신뢰가 생깁니다.

무결성의 종류

|이름|설명|
|--|--|
|개체 무결성|기본키로 선택된 필드는 빈 값을 허용하지 않음|
|참조 무결성|서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야함|
|고유 무결성|특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우 그 속성 값은 모두 고유한 값을 가짐|
|NULL 무결성|특정 속성 값에 NULL이 나올 수 없다는 조건이 주어진 경우 그 속성 값은 NULL이 될 수 없다는 제약 조건|





